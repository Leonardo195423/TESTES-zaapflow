<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Assistente de IA</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos personalizados para a aplicação */
        body {
            font-family: 'Inter', sans-serif;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Animação de carregamento (pontos a saltar) */
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
        .animate-bounce-dot {
            animation: bounce 1.4s infinite ease-in-out both;
        }
        /* Ocultar elementos por defeito */
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app-container" class="flex flex-col h-screen bg-gray-100 font-sans antialiased text-gray-800">
        <!-- Cabeçalho -->
        <header class="bg-gradient-to-r from-blue-600 to-purple-700 text-white p-4 shadow-lg rounded-b-xl flex justify-between items-center relative">
            <button id="hamburger-button" class="p-2 rounded-full hover:bg-white hover:bg-opacity-20 transition duration-200 focus:outline-none focus:ring-2 focus:ring-white hidden" aria-label="Abrir menu de projetos">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
            </button>
            <h1 class="text-3xl font-bold text-center flex-1">Meu Assistente de IA</h1>
            <div class="flex space-x-2">
                <button id="chat-mode-button" class="px-4 py-2 rounded-full text-sm font-semibold transition duration-200 ease-in-out bg-white text-blue-700 shadow-md">
                    Chat
                </button>
                <button id="dev-mode-button" class="px-4 py-2 rounded-full text-sm font-semibold transition duration-200 ease-in-out bg-purple-500 text-white hover:bg-purple-600">
                    Programador
                </button>
            </div>
            <p id="user-id-display" class="absolute bottom-1 right-4 text-xs opacity-70"></p>
        </header>

        <!-- Sidebar para o Modo Programador -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>
        <div id="sidebar" class="fixed top-0 left-0 h-full w-64 bg-gray-800 text-white shadow-lg transform -translate-x-full transition-transform duration-300 ease-in-out z-50">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h2 class="text-xl font-bold">Meus Projetos</h2>
                <button id="close-sidebar-button" class="p-1 rounded-full hover:bg-gray-700 transition duration-200" aria-label="Fechar menu">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div id="projects-list" class="p-4 overflow-y-auto custom-scrollbar">
                <p class="text-gray-400 text-sm">Nenhum projeto guardado ainda.</p>
            </div>
        </div>

        <!-- Conteúdo Principal -->
        <main id="main-content" class="flex-1 overflow-y-auto p-4"></main>

        <!-- Rodapé com a área de input -->
        <footer class="p-4 bg-white border-t border-gray-200 shadow-lg rounded-t-xl">
            <div id="image-preview-container" class="hidden items-center mb-3 p-2 bg-gray-100 rounded-lg shadow-inner">
                <img id="image-preview-img" src="" alt="Pré-visualização da imagem selecionada" class="w-16 h-16 object-cover rounded-md mr-3"/>
                <span id="image-preview-name" class="text-sm text-gray-700 truncate flex-1"></span>
                <button id="clear-image-button" class="ml-2 p-1 rounded-full bg-red-500 text-white hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2" aria-label="Remover imagem">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="flex items-end space-x-3">
                <input type="file" accept="image/*" id="file-input" class="hidden" />
                <button id="attach-image-button" class="p-3 rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition duration-200 ease-in-out transform hover:scale-105" aria-label="Anexar imagem">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                </button>
                <textarea id="prompt-input" class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none h-20 custom-scrollbar" placeholder="Digite sua mensagem aqui..."></textarea>
                <button id="generate-image-dev-button" class="bg-purple-600 text-white p-3 rounded-full shadow-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition duration-200 ease-in-out transform hover:scale-105 hidden" title="Gerar Imagem">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 3v4M3 5h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                    </svg>
                </button>
                <button id="send-button" class="bg-blue-600 text-white p-3 rounded-full shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 ease-in-out transform hover:scale-105" title="Enviar Mensagem">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                    </svg>
                </button>
            </div>
        </footer>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, addDoc, onSnapshot, getDocs, doc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- VARIÁVEIS DE ESTADO GLOBAIS ---
        let appMode = 'chat'; // 'chat' ou 'developer'
        let chatHistory = [];
        let projects = [];
        let codeHistory = [];
        let historyPointer = -1;
        let isLoading = false;
        let selectedImage = null;
        let selectedImageBase64 = null;
        let generationProgress = 0;
        let progressInterval = null;

        // Instâncias do Firebase
        let db, auth, userId, appId;
        let unsubscribeChat = null; // Para anular a inscrição do listener do chat

        // --- ELEMENTOS DO DOM ---
        const mainContent = document.getElementById('main-content');
        const promptInput = document.getElementById('prompt-input');
        const sendButton = document.getElementById('send-button');
        const chatModeButton = document.getElementById('chat-mode-button');
        const devModeButton = document.getElementById('dev-mode-button');
        const hamburgerButton = document.getElementById('hamburger-button');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const closeSidebarButton = document.getElementById('close-sidebar-button');
        const projectsList = document.getElementById('projects-list');
        const userIdDisplay = document.getElementById('user-id-display');
        const fileInput = document.getElementById('file-input');
        const attachImageButton = document.getElementById('attach-image-button');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreviewImg = document.getElementById('image-preview-img');
        const imagePreviewName = document.getElementById('image-preview-name');
        const clearImageButton = document.getElementById('clear-image-button');
        const generateImageDevButton = document.getElementById('generate-image-dev-button');
        
        // --- TEMPLATES HTML ---
        const chatViewTemplate = `
            <div id="chat-history-container" class="space-y-4 h-full custom-scrollbar">
                <div class="flex justify-center items-center h-full">
                    <p class="text-gray-500 text-lg">Comece a conversar com a IA!</p>
                </div>
            </div>
            <div id="messages-end-ref"></div>
        `;

        const developerViewTemplate = `
            <div class="flex-1 flex flex-col lg:flex-row h-full space-y-4 lg:space-y-0 lg:space-x-4">
                <!-- Editor de Código e Controles -->
                <div class="flex-1 flex flex-col bg-white rounded-lg shadow-md p-4">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">Editor de Código</h2>
                    <div class="flex space-x-3 mb-4 items-stretch">
                        <select id="code-type-select" class="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="html">HTML</option>
                            <option value="react">React</option>
                            <option value="javascript">JavaScript</option>
                        </select>
                        <input type="text" id="project-name-input" placeholder="Nome do Projeto" class="flex-1 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"/>
                        <button id="save-project-button" class="px-4 py-2 bg-gradient-to-r from-green-500 to-green-600 text-white font-semibold rounded-lg shadow-md hover:shadow-lg transform hover:scale-105 transition duration-300 ease-in-out flex items-center justify-center min-w-[120px]">Guardar</button>
                        <button id="undo-button" class="px-4 py-2 bg-gradient-to-r from-yellow-500 to-orange-500 text-white font-semibold rounded-lg shadow-md hover:shadow-lg transform hover:scale-105 transition duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center min-w-[120px]" title="Desfazer">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M5 12h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2z" /></svg> Desfazer
                        </button>
                        <button id="copy-code-button" class="px-4 py-2 bg-gradient-to-r from-gray-600 to-gray-700 text-white font-semibold rounded-lg shadow-md hover:shadow-lg transform hover:scale-105 transition duration-300 ease-in-out relative flex items-center justify-center min-w-[120px]">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 5H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-2M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V15m-2.586 2.586a1 1 0 00.707.293h3.414a1 1 0 00.707-.293l3.414-3.414a1 1 0 00.293-.707V9.414a1 1 0 00-.293-.707L15.414 4.293A1 1 0 0014.707 4H12a2 2 0 00-2 2v2" /></svg> Copiar Código
                            <span id="copy-message" class="absolute -top-8 left-1/2 -translate-x-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded shadow-lg whitespace-nowrap hidden"></span>
                        </button>
                    </div>
                    <textarea id="code-content-textarea" class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none custom-scrollbar font-mono text-sm" placeholder="Escreva o seu código aqui..."></textarea>
                </div>
                <!-- Área de Pré-visualização ao Vivo -->
                <div class="flex-1 flex flex-col bg-white rounded-lg shadow-md p-4">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">Pré-visualização ao Vivo</h2>
                    <iframe id="preview-iframe" class="flex-1 w-full border border-gray-300 rounded-lg bg-white" title="Pré-visualização de Código"></iframe>
                    <div id="dev-image-generated-container" class="mt-4 p-4 bg-gray-50 rounded-lg shadow-inner hidden">
                        <h3 class="text-lg font-semibold mb-2 text-gray-700">Imagem Gerada</h3>
                        <div id="dev-image-loading" class="flex justify-center items-center h-32">
                            <div class="w-8 h-8 border-4 border-blue-200 border-t-blue-500 rounded-full animate-spin"></div>
                            <p class="ml-3 text-gray-600">Gerando imagem...</p>
                        </div>
                        <img id="dev-image-generated" src="" alt="Imagem Gerada pela IA" class="max-w-full h-auto rounded-md shadow-sm hidden" />
                    </div>
                </div>
            </div>
        `;

        // --- FUNÇÕES DE RENDERIZAÇÃO E MANIPULAÇÃO DO DOM ---

        /**
         * Renderiza o histórico do chat no DOM.
         */
        function renderChatHistory() {
            const container = document.getElementById('chat-history-container');
            if (!container) return;

            if (chatHistory.length === 0 && !isLoading) {
                container.innerHTML = `
                    <div class="flex justify-center items-center h-full">
                        <p class="text-gray-500 text-lg">Comece a conversar com a IA!</p>
                    </div>`;
                return;
            }
            
            let html = '';
            chatHistory.forEach(message => {
                const isUser = message.role === 'user';
                html += `
                    <div class="flex ${isUser ? 'justify-end' : 'justify-start'}">
                        <div class="max-w-xl p-3 rounded-lg shadow-md ${isUser ? 'bg-blue-500 text-white rounded-br-none' : 'bg-white text-gray-800 rounded-bl-none'}">
                            ${message.text ? `<p class="whitespace-pre-wrap">${message.text}</p>` : ''}
                            ${message.image ? `<img src="${message.image}" alt="Imagem" class="mt-2 rounded-md max-w-full h-auto" style="max-height: 200px;" />` : ''}
                        </div>
                    </div>
                `;
            });

            if (isLoading) {
                html += `
                    <div class="flex justify-start">
                        <div class="max-w-xl p-3 rounded-lg shadow-md bg-white text-gray-800 rounded-bl-none">
                            <div class="flex items-center space-x-2">
                                <div class="w-3 h-3 bg-gray-400 rounded-full animate-bounce-dot" style="animation-delay: 0s;"></div>
                                <div class="w-3 h-3 bg-gray-400 rounded-full animate-bounce-dot" style="animation-delay: 0.1s;"></div>
                                <div class="w-3 h-3 bg-gray-400 rounded-full animate-bounce-dot" style="animation-delay: 0.2s;"></div>
                            </div>
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html;
            document.getElementById('messages-end-ref')?.scrollIntoView({ behavior: 'smooth' });
        }

        /**
         * Renderiza a lista de projetos na sidebar.
         */
        function renderProjectsList() {
            if (projects.length === 0) {
                projectsList.innerHTML = `<p class="text-gray-400 text-sm">Nenhum projeto guardado ainda.</p>`;
                return;
            }
            
            const ul = document.createElement('ul');
            projects.forEach(project => {
                const li = document.createElement('li');
                li.className = "py-2 border-b border-gray-700 last:border-b-0";
                li.innerHTML = `
                    <button data-project-id="${project.id}" class="w-full text-left text-white hover:text-blue-400 transition duration-200 truncate">
                        <span class="font-medium">${project.name}</span>
                        <span class="text-xs text-gray-400"> (${project.type})</span>
                    </button>
                `;
                ul.appendChild(li);
            });
            projectsList.innerHTML = '';
            projectsList.appendChild(ul);
        }

        /**
         * Atualiza a interface do utilizador com base no modo da aplicação ('chat' ou 'developer').
         */
        function updateUIForMode() {
            if (appMode === 'chat') {
                // Configuração do modo Chat
                mainContent.innerHTML = chatViewTemplate;
                chatModeButton.className = 'px-4 py-2 rounded-full text-sm font-semibold transition duration-200 ease-in-out bg-white text-blue-700 shadow-md';
                devModeButton.className = 'px-4 py-2 rounded-full text-sm font-semibold transition duration-200 ease-in-out bg-purple-500 text-white hover:bg-purple-600';
                hamburgerButton.classList.add('hidden');
                promptInput.placeholder = "Digite sua mensagem aqui...";
                sendButton.title = "Enviar Mensagem";
                generateImageDevButton.classList.add('hidden');
                renderChatHistory();
                subscribeToChatHistory();
            } else {
                // Configuração do modo Programador
                if (unsubscribeChat) unsubscribeChat(); // Anular subscrição do chat
                mainContent.innerHTML = developerViewTemplate;
                devModeButton.className = 'px-4 py-2 rounded-full text-sm font-semibold transition duration-200 ease-in-out bg-white text-purple-700 shadow-md';
                chatModeButton.className = 'px-4 py-2 rounded-full text-sm font-semibold transition duration-200 ease-in-out bg-blue-500 text-white hover:bg-blue-600';
                hamburgerButton.classList.remove('hidden');
                promptInput.placeholder = "Descreva o código que deseja gerar, depurar ou refinar...";
                sendButton.title = "Pedir Ajuda à IA";
                generateImageDevButton.classList.remove('hidden');
                addDeveloperEventListeners();
                loadProjects();
            }
            updateButtonStates();
        }

        /**
         * Atualiza o estado (ativado/desativado) dos botões.
         */
        function updateButtonStates() {
            const promptIsEmpty = !promptInput.value.trim();
            const imageIsSelected = !!selectedImage;

            sendButton.disabled = isLoading || (appMode === 'chat' && promptIsEmpty && !imageIsSelected) || (appMode === 'developer' && promptIsEmpty && !imageIsSelected);
            generateImageDevButton.disabled = isLoading || promptIsEmpty;
            attachImageButton.disabled = isLoading;
            promptInput.disabled = isLoading;
        }

        // --- FUNÇÕES DE LÓGICA DA APLICAÇÃO ---

        /**
         * Muda o modo da aplicação.
         * @param {string} newMode - O novo modo ('chat' ou 'developer').
         */
        function setAppMode(newMode) {
            if (appMode === newMode) return;
            appMode = newMode;
            updateUIForMode();
        }

        /**
         * Limpa a imagem selecionada.
         */
        function clearSelectedImage() {
            selectedImage = null;
            selectedImageBase64 = null;
            fileInput.value = '';
            imagePreviewContainer.classList.add('hidden');
            updateButtonStates();
        }

        /**
         * Executa o código na iframe de pré-visualização.
         */
        function runCode() {
            const iframe = document.getElementById('preview-iframe');
            if (!iframe) return;

            const codeContent = document.getElementById('code-content-textarea').value;
            const codeType = document.getElementById('code-type-select').value;
            const doc = iframe.contentWindow.document;
            doc.open();
            if (codeType === 'html') {
                doc.write(codeContent);
            } else if (codeType === 'javascript') {
                doc.write(`<html><body><script>${codeContent}<\/script></body></html>`);
            } else if (codeType === 'react') {
                const reactHtml = `
                    <!DOCTYPE html>
                    <html><head>
                        <title>Pré-visualização React</title>
                        <script src="https://unpkg.com/react/umd/react.development.js"><\/script>
                        <script src="https://unpkg.com/react-dom/umd/react-dom.development.js"><\/script>
                        <script src="https://unpkg.com/@babel/standalone/babel.min.js"><\/script>
                        <script src="https://cdn.tailwindcss.com"><\/script>
                        <style>body { margin: 0; font-family: 'Inter', sans-serif; } #root { height: 100vh; width: 100vw; }</style>
                    </head><body>
                        <div id="root"></div>
                        <script type="text/babel">
                            ${codeContent}
                            // Assegura que o componente App é renderizado
                            if (typeof App !== 'undefined') {
                                ReactDOM.render(<App />, document.getElementById('root'));
                            }
                        <\/script>
                    </body></html>`;
                doc.write(reactHtml);
            }
            doc.close();
        }
        
        /**
         * Copia o código do editor para a área de transferência.
         */
        function copyCodeToClipboard() {
            const codeContentEl = document.getElementById('code-content-textarea');
            const copyMessageEl = document.getElementById('copy-message');
            if (!codeContentEl || !copyMessageEl) return;

            // Cria um textarea temporário
            const textarea = document.createElement('textarea');
            textarea.value = codeContentEl.value;
            textarea.style.position = 'absolute';
            textarea.style.left = '-9999px'; // Move-o para fora do ecrã
            document.body.appendChild(textarea);
            
            try {
                textarea.select();
                document.execCommand('copy'); // Comando de cópia
                copyMessageEl.textContent = 'Código copiado!';
                copyMessageEl.classList.remove('hidden');
                setTimeout(() => copyMessageEl.classList.add('hidden'), 2000);
            } catch (err) {
                console.error('Falha ao copiar o código: ', err);
                copyMessageEl.textContent = 'Falha ao copiar!';
                copyMessageEl.classList.remove('hidden');
                setTimeout(() => copyMessageEl.classList.add('hidden'), 2000);
            } finally {
                // Remove o textarea temporário
                document.body.removeChild(textarea);
            }
        }

        /**
         * Guarda o projeto atual no Firestore.
         */
        async function saveProject() {
            const projectName = document.getElementById('project-name-input').value.trim();
            const codeContent = document.getElementById('code-content-textarea').value.trim();
            const codeType = document.getElementById('code-type-select').value;

            if (!projectName || !codeContent || !db || !userId) {
                console.error("Nome do projeto, conteúdo do código ou dados do utilizador/DB em falta.");
                alert("Por favor, preencha o nome do projeto e o código antes de guardar.");
                return;
            }
            const projectsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/projects`);
            try {
                await addDoc(projectsCollectionRef, {
                    name: projectName,
                    code: codeContent,
                    type: codeType,
                    timestamp: Date.now()
                });
                alert("Projeto guardado com sucesso!");
                loadProjects();
            } catch (error) {
                console.error("Erro ao guardar projeto:", error);
                alert("Ocorreu um erro ao guardar o projeto.");
            }
        }

        /**
         * Carrega os projetos do utilizador a partir do Firestore.
         */
        async function loadProjects() {
            if (!db || !userId) return;
            const projectsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/projects`);
            const q = query(projectsCollectionRef, orderBy('timestamp', 'desc'));

            try {
                const snapshot = await getDocs(q);
                projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProjectsList();
            } catch (error) {
                console.error("Erro ao carregar projetos:", error);
            }
        }

        /**
         * Seleciona um projeto para carregar no editor.
         */
        function selectProject(project) {
            addStateToHistory();
            document.getElementById('code-content-textarea').value = project.code;
            document.getElementById('code-type-select').value = project.type;
            document.getElementById('project-name-input').value = project.name;
            document.getElementById('dev-image-generated-container').classList.add('hidden');
            sidebar.classList.add('-translate-x-full');
            sidebarOverlay.classList.add('hidden');
            runCode();
        }

        /**
         * Adiciona o estado atual do código ao histórico para a funcionalidade de anular.
         */
        function addStateToHistory() {
            const codeContent = document.getElementById('code-content-textarea').value;
            const codeType = document.getElementById('code-type-select').value;
            const projectName = document.getElementById('project-name-input').value;

            const newHistory = codeHistory.slice(0, historyPointer + 1);
            const MAX_HISTORY_SIZE = 20;
            if (newHistory.length >= MAX_HISTORY_SIZE) {
                newHistory.shift();
            }
            newHistory.push({ codeContent, codeType, projectName });
            codeHistory = newHistory;
            historyPointer = newHistory.length - 1;
            document.getElementById('undo-button').disabled = historyPointer <= 0;
        }

        /**
         * Anula a última alteração de código.
         */
        function undoCodeChange() {
            if (historyPointer > 0) {
                historyPointer--;
                const previousState = codeHistory[historyPointer];
                document.getElementById('code-content-textarea').value = previousState.codeContent;
                document.getElementById('code-type-select').value = previousState.codeType;
                document.getElementById('project-name-input').value = previousState.projectName;
                document.getElementById('dev-image-generated-container').classList.add('hidden');
                document.getElementById('undo-button').disabled = historyPointer <= 0;
                runCode();
            }
        }

        /**
         * Envia uma mensagem para a IA (texto, código ou imagem).
         * @param {string} mode - O tipo de pedido ('text', 'code', 'image', 'generateImageDev').
         */
        async function sendMessage(mode) {
            const currentPrompt = promptInput.value.trim();
            if (isLoading || !db || !userId) return;
            if ((appMode === 'chat' && !currentPrompt && !selectedImage) || (appMode === 'developer' && !currentPrompt && mode !== 'generateImageDev')) return;

            isLoading = true;
            updateButtonStates();

            const chatCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/chatHistory`);

            try {
                if (appMode === 'developer') {
                    const codeTextarea = document.getElementById('code-content-textarea');
                    if (mode === 'generateImageDev') {
                        const devImgContainer = document.getElementById('dev-image-generated-container');
                        const devImgLoading = document.getElementById('dev-image-loading');
                        const devImgGenerated = document.getElementById('dev-image-generated');
                        
                        devImgContainer.classList.remove('hidden');
                        devImgLoading.classList.remove('hidden');
                        devImgGenerated.classList.add('hidden');

                        const imagePayload = { instances: { prompt: currentPrompt }, parameters: { "sampleCount": 1 } };
                        const imageApiKey = ""; 
                        const imageApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${imageApiKey}`;
                        const imageResponse = await fetch(imageApiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(imagePayload)
                        });
                        const imageResult = await imageResponse.json();

                        if (imageResult.predictions && imageResult.predictions[0].bytesBase64Encoded) {
                            const imageUrl = `data:image/png;base64,${imageResult.predictions[0].bytesBase64Encoded}`;
                            devImgGenerated.src = imageUrl;
                            devImgGenerated.classList.remove('hidden');
                        } else {
                            console.error("Erro ao gerar imagem no modo programador:", imageResult);
                            devImgContainer.classList.add('hidden');
                        }
                        devImgLoading.classList.add('hidden');

                    } else { // Geração/Refinamento de Código
                        generationProgress = 0;
                        if (progressInterval) clearInterval(progressInterval);

                        progressInterval = setInterval(() => {
                            if (generationProgress < 99) {
                                generationProgress++;
                                codeTextarea.value = `Gerando código... ${generationProgress}%`;
                            } else {
                                clearInterval(progressInterval);
                                progressInterval = null;
                            }
                        }, 100);
                        
                        const codeContent = document.getElementById('code-content-textarea').value;
                        const codeType = document.getElementById('code-type-select').value;
                        let designInstruction = "Garanta que o design é robusto, avançado e esteticamente refinado, utilizando as classes do Tailwind CSS para um estilo moderno e responsivo.";
                        
                        const developerPromptParts = [
                            { text: `Dado o seguinte código de tipo '${codeType}':\n\n\`\`\`${codeType}\n${codeContent}\n\`\`\`\n\n` },
                            { text: `E o pedido do utilizador: '${currentPrompt}'. ` }
                        ];
                        if (selectedImageBase64) {
                            developerPromptParts.push({ text: 'Analise a imagem fornecida para referência.' });
                            developerPromptParts.push({ inlineData: { mimeType: selectedImage.type, data: selectedImageBase64 } });
                        }
                        developerPromptParts.push({ text: `\n\nForneça APENAS o código puro (sem markdown extra). ${designInstruction}` });

                        const payload = { contents: [{ role: "user", parts: developerPromptParts }] };
                        const apiKey = "";
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        const result = await response.json();
                        
                        clearInterval(progressInterval);
                        progressInterval = null;

                        if (result.candidates && result.candidates[0].content.parts[0].text) {
                            let aiResponseText = result.candidates[0].content.parts[0].text;
                            const codeBlockMatch = aiResponseText.match(/```(?:\w+)?\n([\s\S]*?)\n```/);
                            if (codeBlockMatch && codeBlockMatch[1]) {
                                codeTextarea.value = codeBlockMatch[1].trim();
                            } else {
                                codeTextarea.value = aiResponseText;
                            }
                            runCode();
                            addStateToHistory();
                        } else {
                            codeTextarea.value = "Erro ao gerar código. Por favor, tente novamente.";
                        }
                    }
                } else { // appMode === 'chat'
                    renderChatHistory(); 
                    
                    if (mode === 'image') {
                        await addDoc(chatCollectionRef, { role: 'user', text: `Gerar imagem: "${currentPrompt}"`, timestamp: Date.now() });
                        
                        const imagePayload = { instances: { prompt: currentPrompt }, parameters: { "sampleCount": 1 } };
                        const imageApiKey = "";
                        const imageApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${imageApiKey}`;
                        const imageResponse = await fetch(imageApiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(imagePayload) });
                        const imageResult = await imageResponse.json();

                        if (imageResult.predictions && imageResult.predictions[0].bytesBase64Encoded) {
                            const imageUrl = `data:image/png;base64,${imageResult.predictions[0].bytesBase64Encoded}`;
                            await addDoc(chatCollectionRef, { role: 'model', image: imageUrl, timestamp: Date.now() });
                        } else {
                            await addDoc(chatCollectionRef, { role: 'model', text: "Desculpe, não consegui gerar a imagem.", timestamp: Date.now() });
                        }
                    } else { // modo 'text'
                        const userMessage = {
                            role: 'user',
                            text: currentPrompt,
                            timestamp: Date.now(),
                            image: selectedImageBase64 ? `data:${selectedImage.type};base64,${selectedImageBase64}` : null
                        };
                        await addDoc(chatCollectionRef, userMessage);
                        
                        const chatHistoryForApi = chatHistory.map(msg => ({ role: msg.role, parts: [{ text: msg.text || '' }] }));
                        const currentUserPromptParts = [{ text: currentPrompt }];
                        if (selectedImageBase64) {
                            currentUserPromptParts.push({ inlineData: { mimeType: selectedImage.type, data: selectedImageBase64 } });
                        }
                        chatHistoryForApi.push({ role: 'user', parts: currentUserPromptParts });

                        const payload = { contents: chatHistoryForApi };
                        const apiKey = "";
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        const result = await response.json();

                        if (result.candidates && result.candidates[0].content.parts[0].text) {
                            await addDoc(chatCollectionRef, { role: 'model', text: result.candidates[0].content.parts[0].text, timestamp: Date.now() });
                        } else {
                            await addDoc(chatCollectionRef, { role: 'model', text: "Desculpe, não consegui gerar uma resposta.", timestamp: Date.now() });
                        }
                    }
                }
            } catch (error) {
                console.error("Erro ao enviar mensagem ou chamar a API:", error);
                if (progressInterval) clearInterval(progressInterval);
                if (appMode === 'chat') {
                    await addDoc(chatCollectionRef, { role: 'model', text: "Ocorreu um erro.", timestamp: Date.now() });
                } else {
                    document.getElementById('code-content-textarea').value = "Ocorreu um erro ao comunicar com a IA.";
                }
            } finally {
                if (progressInterval) clearInterval(progressInterval);
                isLoading = false;
                promptInput.value = '';
                clearSelectedImage();
                updateButtonStates();
                if(appMode === 'chat') renderChatHistory();
            }
        }
        
        /**
         * Subscreve às atualizações em tempo real do histórico do chat no Firestore.
         */
        function subscribeToChatHistory() {
            if (unsubscribeChat) unsubscribeChat(); // Anular subscrição anterior
            if (!db || !userId) return;

            const chatCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/chatHistory`);
            const q = query(chatCollectionRef, orderBy('timestamp'));

            unsubscribeChat = onSnapshot(q, (snapshot) => {
                chatHistory = snapshot.docs.map(doc => doc.data());
                renderChatHistory();
            }, (error) => {
                console.error("Erro ao obter histórico do chat:", error);
            });
        }

        // --- INICIALIZAÇÃO E LISTENERS DE EVENTOS ---
        
        /**
         * Adiciona listeners de eventos para os elementos do modo programador.
         */
        function addDeveloperEventListeners() {
            document.getElementById('save-project-button')?.addEventListener('click', saveProject);
            document.getElementById('undo-button')?.addEventListener('click', undoCodeChange);
            document.getElementById('copy-code-button')?.addEventListener('click', copyCodeToClipboard);
            document.getElementById('code-content-textarea')?.addEventListener('input', runCode);
            document.getElementById('code-type-select')?.addEventListener('change', runCode);
            document.getElementById('code-content-textarea')?.addEventListener('input', addStateToHistory);
        }

        /**
         * Inicializa a aplicação quando o DOM está carregado.
         */
        document.addEventListener('DOMContentLoaded', async () => {
            // Inicialização do Firebase
            try {
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        userId = crypto.randomUUID();
                    }
                    userIdDisplay.textContent = `ID do Utilizador: ${userId}`;
                    updateUIForMode(); // Chamar aqui para garantir que o userId está definido
                });

            } catch (error) {
                console.error("Erro ao inicializar o Firebase:", error);
                alert("Não foi possível conectar aos nossos serviços. Por favor, atualize a página.");
            }

            // Listeners de eventos globais
            chatModeButton.addEventListener('click', () => setAppMode('chat'));
            devModeButton.addEventListener('click', () => setAppMode('developer'));
            
            hamburgerButton.addEventListener('click', () => {
                sidebar.classList.remove('-translate-x-full');
                sidebarOverlay.classList.remove('hidden');
            });
            closeSidebarButton.addEventListener('click', () => {
                sidebar.classList.add('-translate-x-full');
                sidebarOverlay.classList.add('hidden');
            });
            sidebarOverlay.addEventListener('click', () => {
                sidebar.classList.add('-translate-x-full');
                sidebarOverlay.classList.add('hidden');
            });

            sendButton.addEventListener('click', () => sendMessage(appMode === 'chat' ? 'text' : 'code'));
            generateImageDevButton.addEventListener('click', () => sendMessage('generateImageDev'));

            promptInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage(appMode === 'chat' ? 'text' : 'code');
                }
            });
            promptInput.addEventListener('input', updateButtonStates);
            
            attachImageButton.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    selectedImage = file;
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        selectedImageBase64 = reader.result.split(',')[1];
                        imagePreviewImg.src = reader.result;
                        imagePreviewName.textContent = file.name;
                        imagePreviewContainer.classList.remove('hidden');
                        updateButtonStates();
                    };
                    reader.readAsDataURL(file);
                }
            });
            clearImageButton.addEventListener('click', clearSelectedImage);

            projectsList.addEventListener('click', (e) => {
                const button = e.target.closest('button[data-project-id]');
                if (button) {
                    const projectId = button.dataset.projectId;
                    const project = projects.find(p => p.id === projectId);
                    if (project) {
                        selectProject(project);
                    }
                }
            });
            
            // Estado inicial da UI
            updateUIForMode();
        });
    </script>
</body>
</html>
